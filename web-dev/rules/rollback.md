# Rollback Rules (되돌림 규칙)

> 이 문서는 REJECT, FAIL, BLOCK 발생 시 누가 무엇을 수정하고
> 어떻게 재진행하는지 정의한다.
> Manager는 이 규칙을 기준으로 되돌림을 판단한다.

---

## 1. 되돌림 원칙

- 되돌림은 **문제의 근본 원인이 있는 단계**로 한다
- 되돌림 시 **수정 범위를 명확히** 지정한다
- 수정 후 **이전 단계부터 다시 검증**한다
- 같은 문제로 **3회 이상 되돌림 시 Manager 개입** 필수

---

## 2. Reviewer REJECT 시 되돌림

### 2.1 판정 기준
| REJECT 유형 | 되돌림 대상 | Manager 개입 |
|-------------|-------------|--------------|
| 백엔드 구조/구현 문제 | Backend | 불필요 |
| 프론트엔드 구조/구현 문제 | Frontend | 불필요 |
| API 계약 위반 (Backend 원인) | Backend | 불필요 |
| API 계약 위반 (Frontend 원인) | Frontend | 불필요 |
| API 계약 자체 문제 | Backend + Frontend | 필요 |
| project.md 규칙 위반 | 해당 역할 | 필요 (재발 방지) |
| 아키텍처 수준 문제 | Architect | 필요 |

### 2.2 되돌림 프로세스

```
Reviewer REJECT
    ↓
REJECT 유형 분류
    ↓
┌─────────────────────────────────────────────────┐
│ 단순 구현 문제 (Manager 개입 불필요)             │
├─────────────────────────────────────────────────┤
│ 1. Reviewer가 해당 역할에 REJECT 사유 전달      │
│ 2. 해당 역할이 수정                              │
│ 3. 수정 완료 후 Reviewer에게 재제출              │
│ 4. Reviewer 재검토                               │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 구조적 문제 (Manager 개입 필요)                  │
├─────────────────────────────────────────────────┤
│ 1. Reviewer가 Manager에게 에스컬레이션           │
│ 2. Manager가 원인 분석 및 되돌림 대상 결정       │
│ 3. decision.md에 판단 기록                       │
│ 4. 지정된 역할이 수정                            │
│ 5. 수정 완료 후 영향받는 모든 단계 재검증        │
└─────────────────────────────────────────────────┘
```

### 2.3 REJECT 후 재제출 규칙

- 수정 내용을 **명시적으로 기록**
- REJECT 사유가 **모두 해결**되었음을 확인
- 새로운 문제를 **도입하지 않았음**을 자체 검증
- **동일 사유 재REJECT 시** Manager 보고

---

## 3. QA FAIL 시 되돌림

### 3.1 원인별 되돌림 대상

| FAIL 원인 | 되돌림 대상 | 판단 주체 |
|-----------|-------------|-----------|
| 백엔드 구현 누락/오류 | Backend | Manager |
| 프론트엔드 구현 누락/오류 | Frontend | Manager |
| API 응답이 기획과 불일치 | Backend | Manager |
| 화면 흐름이 기획과 불일치 | Frontend | Manager |
| 기획 자체가 모호/불완전 | Planner | Manager |
| 기술적으로 구현 불가 | Architect | Manager |
| API 계약이 기획을 반영 안 함 | Backend | Manager |

### 3.2 되돌림 프로세스

```
QA FAIL
    ↓
QA가 qa-report.md 작성
    ↓
Manager에게 보고
    ↓
Manager 원인 분석
    ↓
┌─────────────┬─────────────┬─────────────┐
│ 구현 문제    │ 기획 문제    │ 기술 문제    │
├─────────────┼─────────────┼─────────────┤
│ Backend     │ Planner     │ Architect   │
│ 또는        │             │             │
│ Frontend    │             │             │
└─────────────┴─────────────┴─────────────┘
    ↓
decision.md에 판단 기록
    ↓
지정 역할 수정
    ↓
영향받는 단계부터 재진행
```

### 3.3 FAIL 후 재검증 범위

| 수정 역할 | 재검증 시작점 |
|-----------|--------------|
| Backend만 수정 | Reviewer → QA |
| Frontend만 수정 | Reviewer → QA |
| Backend + Frontend 수정 | Reviewer → QA |
| Planner 수정 (plan.md) | Architect → Backend/Frontend → Reviewer → QA |
| Architect 수정 (project.md) | Backend/Frontend → Reviewer → QA |

---

## 4. BLOCK 시 되돌림

### 4.1 BLOCK 유형별 처리

| BLOCK 유형 | 발생 단계 | 처리 방법 |
|------------|----------|----------|
| 문서 부족 | 모든 단계 | 이전 역할로 되돌려 문서 보완 |
| 판단 불가 (모호함) | QA, Reviewer | Manager가 해석 제공 또는 Planner로 되돌림 |
| 기술 제약 발견 | 개발 | Manager → Architect로 재설계 |
| 외부 의존성 | 개발 | Manager 판단 (대기/우회/취소) |

### 4.2 BLOCK 해제 조건

```
BLOCK 발생
    ↓
Manager 판단
    ↓
┌─────────────────────────────────────────────────┐
│ 해제 조건 충족 시                                │
├─────────────────────────────────────────────────┤
│ 1. BLOCK 원인이 해결됨                           │
│ 2. 해결 내용이 문서에 반영됨                     │
│ 3. Manager가 해제 승인                           │
│ 4. decision.md에 해제 기록                       │
└─────────────────────────────────────────────────┘
    ↓
BLOCK 발생 단계부터 재진행
```

---

## 5. 문서 수정 시 연쇄 영향

문서 수정 시 하위 문서도 검토/갱신이 필요할 수 있다.

### 5.1 연쇄 영향 매트릭스

| 수정 문서 | 영향받는 문서 | 재검토 필요 |
|-----------|-------------|------------|
| plan.md | architecture-options.md, project.md, api.md, ui.md | 전체 재검토 |
| project.md | api.md, ui.md | 기술 스택 관련 부분 |
| api.md | ui.md | Frontend 연동 부분 |
| architecture-options.md | project.md | 미확정→확정 시 |

### 5.2 연쇄 갱신 프로세스

```
plan.md 수정 (예: 기능 추가)
    ↓
Manager 영향 범위 판단
    ↓
영향받는 역할 순서대로 갱신
    ↓
┌─────────────────────────────────────────────────┐
│ 1. Architect: project.md 재검토                  │
│    - 규모 변경 필요? → 재산정                    │
│    - 기술 스택 변경 필요? → 재협의                │
│                                                  │
│ 2. Backend: api.md 갱신                          │
│    - 새 엔드포인트 추가                          │
│    - 기존 API 영향 검토                          │
│                                                  │
│ 3. Frontend: ui.md 갱신                          │
│    - 새 화면/흐름 추가                           │
│    - 기존 화면 영향 검토                         │
│                                                  │
│ 4. Reviewer → QA 재검증                          │
└─────────────────────────────────────────────────┘
```

---

## 6. 되돌림 제한 규칙

### 6.1 반복 되돌림 방지

| 상황 | 조치 |
|------|------|
| 같은 사유로 2회 되돌림 | Manager 경고 + 원인 분석 |
| 같은 사유로 3회 되돌림 | Manager 개입 필수 + 프로세스 점검 |
| 같은 사유로 4회 이상 | 해당 기능 보류 또는 접근 방식 변경 |

### 6.2 되돌림 범위 제한

- 한 번에 **2단계 이상 되돌림은 Manager 승인** 필요
- **project.md 수정이 필요한 되돌림**은 Manager 필수 승인
- **Frozen 문서 수정**은 되돌림이 아닌 **새 버전** 생성

---

## 7. 되돌림 기록 형식

decision.md에 다음 형식으로 기록:

```markdown
## Rollback #[번호]

- Date: YYYY-MM-DD
- Trigger: REJECT / FAIL / BLOCK
- From Stage: [되돌림 발생 단계]
- To Stage: [되돌림 대상 단계]
- Target Role: [수정 담당 역할]

### Cause
[되돌림 원인 - 사실만]

### Required Fix
[수정해야 할 내용]

### Affected Documents
- [ ] plan.md
- [ ] project.md
- [ ] api.md
- [ ] ui.md

### Re-verification Path
[재검증 시작점] → [재검증 종료점]

### Resolution
- Status: PENDING / RESOLVED
- Resolved Date: 
- Resolution Summary:
```

---

## 8. 되돌림 흐름 요약

```
┌─────────────────────────────────────────────────────────────────┐
│                        되돌림 판단 흐름                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  REJECT/FAIL/BLOCK 발생                                          │
│         ↓                                                        │
│  원인 분석 (누가?)                                                │
│    - 단순 구현: 해당 역할                                         │
│    - 구조적: Manager                                              │
│         ↓                                                        │
│  되돌림 대상 결정                                                 │
│    - 구현 문제 → Backend/Frontend                                │
│    - 기획 문제 → Planner                                         │
│    - 기술 문제 → Architect                                       │
│         ↓                                                        │
│  수정 범위 명시                                                   │
│         ↓                                                        │
│  decision.md 기록                                                 │
│         ↓                                                        │
│  수정 수행                                                        │
│         ↓                                                        │
│  재검증 (영향받는 단계부터)                                       │
│         ↓                                                        │
│  완료 또는 재되돌림                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```
